"""
Vulnerability triage functionality.
"""

import os
import logging
import nvdlib
from typing import Optional, Dict, Any
from .models import VulnerabilityResult, VulnerabilityDetails
from .utils import extract_cve_id, get_recommendation
from .http_client import get_http_client
from .constants import APIEndpoints

logger = logging.getLogger(__name__)


class CVSSExtractor:
    """Extract CVSS information from CVE data."""
    
    @staticmethod
    def extract_from_nvd(cve) -> tuple[Optional[str], Optional[float], Optional[str]]:
        """
        Extract CVSS data from NVD CVE object.
        
        Args:
            cve: NVD CVE object
            
        Returns:
            Tuple of (severity, score, vector)
        """
        # Try CVSS v4.0 (newest)
        if hasattr(cve, 'v40severity'):
            return cve.v40severity, cve.v40score, cve.v40vector
        
        # Try CVSS v3.1
        if hasattr(cve, 'v31severity'):
            return cve.v31severity, cve.v31score, cve.v31vector
        
        # Try CVSS v3.0
        if hasattr(cve, 'v30severity'):
            return cve.v30severity, cve.v30score, cve.v30vector
        
        # Fallback to CVSS v2
        if hasattr(cve, 'v2severity'):
            return cve.v2severity, cve.v2score, cve.v2vector
        
        return None, None, "N/A"
    
    @staticmethod
    def extract_from_cveorg(metric: Dict[str, Any]) -> tuple[Optional[str], Optional[float], Optional[str]]:
        """
        Extract CVSS data from cve.org metric.
        
        Args:
            metric: Metric dictionary from cve.org API
            
        Returns:
            Tuple of (severity, score, vector)
        """
        # Try different CVSS versions
        for version in ['cvssV4_0', 'cvssV3_1', 'cvssV3_0', 'cvssV2_0']:
            if version in metric:
                cvss = metric[version]
                return (
                    cvss.get('baseSeverity'),
                    cvss.get('baseScore'),
                    cvss.get('vectorString', 'N/A')
                )
        
        return None, None, "N/A"


class VulnerabilityTriager:
    """Handles vulnerability triage operations."""
    
    def __init__(self):
        """Initialize the triager."""
        self.api_key = os.getenv('NVD_API_KEY')
        self.http_client = get_http_client()
    
    def triage(self, vuln_description: str) -> VulnerabilityResult:
        """
        Triage a vulnerability by CVE ID.
        
        Args:
            vuln_description: Description containing CVE ID
            
        Returns:
            VulnerabilityResult with severity and recommendations
        """
        # Extract CVE ID
        cve_id = extract_cve_id(vuln_description)
        if not cve_id:
            logger.warning("No valid CVE ID found in description")
            return {
                "severity": "UNKNOWN",
                "recommendation": "No valid CVE ID found in description.",
                "details": {}
            }
        
        logger.info(f"Triaging vulnerability: {cve_id}")
        
        # Try NVD first
        result = self._try_nvd(cve_id)
        if result:
            return result
        
        # Fallback to cve.org
        logger.info(f"NVD lookup failed, trying cve.org for {cve_id}")
        result = self._try_cveorg(cve_id)
        if result:
            return result
        
        # Both failed
        logger.error(f"Failed to triage {cve_id} from all sources")
        return {
            "severity": "ERROR",
            "recommendation": "Failed to retrieve CVE information from all sources.",
            "details": {"cve_id": cve_id}
        }
    
    def _try_nvd(self, cve_id: str) -> Optional[VulnerabilityResult]:
        """
        Try to get CVE information from NVD.
        
        Args:
            cve_id: CVE identifier
            
        Returns:
            VulnerabilityResult or None on failure
        """
        try:
            logger.debug(f"Querying NVD for {cve_id}")
            results = nvdlib.searchCVE(cveId=cve_id, key=self.api_key)
            
            if not results:
                logger.warning(f"CVE not found in NVD: {cve_id}")
                return None
            
            cve = results[0]
            
            # Extract CVSS information
            severity, score, cvss_vector = CVSSExtractor.extract_from_nvd(cve)
            
            if not severity:
                severity = "UNKNOWN"
                score = "unknown"
            
            # Get description
            description = (
                cve.descriptions[0].value 
                if cve.descriptions 
                else "No description available."
            )
            
            # Build result
            details: VulnerabilityDetails = {
                "cve_id": cve.id,
                "published": str(cve.published),
                "last_modified": str(cve.lastModified),
                "cvss_score": score,
                "cvss_vector": cvss_vector,
                "description": description,
                "source": "NVD"
            }
            
            return {
                "severity": severity,
                "recommendation": get_recommendation(severity),
                "details": details
            }
        
        except Exception as e:
            logger.error(f"NVD query failed for {cve_id}: {e}")
            return None
    
    def _try_cveorg(self, cve_id: str) -> Optional[VulnerabilityResult]:
        """
        Try to get CVE information from cve.org.
        
        Args:
            cve_id: CVE identifier
            
        Returns:
            VulnerabilityResult or None on failure
        """
        try:
            url = APIEndpoints.CVE_ORG.format(cve_id=cve_id)
            logger.debug(f"Querying cve.org for {cve_id}")
            
            data = self.http_client.get_json(url)
            if not data:
                return None
            
            # Validate structure
            if 'containers' not in data or 'cna' not in data['containers']:
                logger.warning(f"Invalid cve.org response for {cve_id}")
                return None
            
            cna = data['containers']['cna']
            
            # Extract description
            description = (
                cna['descriptions'][0]['value']
                if 'descriptions' in cna and cna['descriptions']
                else "No description available."
            )
            
            # Extract CVSS
            severity = "UNKNOWN"
            score = "unknown"
            cvss_vector = "N/A"
            
            if 'metrics' in cna and cna['metrics']:
                severity, score, cvss_vector = CVSSExtractor.extract_from_cveorg(
                    cna['metrics'][0]
                )
            
            # Build result
            details: VulnerabilityDetails = {
                "cve_id": cve_id,
                "published": cna.get('published', 'N/A'),
                "last_modified": cna.get('lastModified', 'N/A'),
                "cvss_score": score,
                "cvss_vector": cvss_vector,
                "description": description,
                "source": "cve.org"
            }
            
            return {
                "severity": severity if severity else "UNKNOWN",
                "recommendation": get_recommendation(severity if severity else "UNKNOWN"),
                "details": details
            }
        
        except Exception as e:
            logger.error(f"cve.org query failed for {cve_id}: {e}")
            return None


# Create tool function for agent
def triage_vulnerability(vuln_description: str) -> dict:
    """
    Triage a vulnerability by extracting CVE ID and querying vulnerability databases.
    
    This is the main entry point used by the agent.
    
    Args:
        vuln_description: Description containing CVE ID
        
    Returns:
        Dictionary with severity, recommendation, and details
    """
    triager = VulnerabilityTriager()
    return triager.triage(vuln_description)
